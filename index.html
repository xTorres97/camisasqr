<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>AR Camiseta - Debug init</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
  <style>
    body, html { margin:0; padding:0; height:100%; overflow:hidden; background:#000; color:#fff; font-family:Arial, sans-serif; }
    #startBtn { position:fixed; left:50%; top:50%; transform:translate(-50%,-50%); padding:12px 18px; font-size:16px; border-radius:8px; background:#ff4fa8; color:white; border:none; cursor:pointer; display:none; }
    #note { position:fixed; bottom:10px; left:10px; right:10px; text-align:center; font-size:14px; opacity:0.9; }
    #log { position:fixed; top:8px; left:8px; padding:8px; background:rgba(0,0,0,0.6); color:#fff; border-radius:6px; max-width:40%; font-size:12px; }
  </style>
</head>
<body>
  <div id="log">Inicializando...</div>
  <button id="startBtn">Activar AR</button>
  <div id="note">Apunta la cámara hacia la imagen de la camiseta</div>

  <!-- a-scene: dejamos mindar-image vacío inicialmente; lo rellenamos dinámicamente -->
  <a-scene id="arScene"
      embedded color-space="sRGB" vr-mode-ui="enabled: false"
      renderer="colorManagement: true; physicallyCorrectLights: true;">
    <a-entity camera></a-entity>
    <a-entity mindar-image-target="targetIndex: 0">
      <a-entity id="animHeart" position="0 0 0">
        <a-sphere radius="0.01" color="#ff7ac8" opacity="0.85"
          animation__appear="property: scale; from: 0 0 0; to: 0.15 0.15 0.15; dur: 800; easing: easeOutQuad; loop: true; dir: alternate"
          animation__pulse="property: opacity; from: 0.5; to: 1; dur: 1000; loop: true; dir: alternate"
          animation__spin="property: rotation; to: 0 360 0; dur: 5000; loop: true">
        </a-sphere>
        <a-ring radius-inner="0.02" radius-outer="0.022" color="#ff9bd5" opacity="0.7" rotation="-90 0 0"
          animation__grow="property: scale; from: 0.1 0.1 0.1; to: 2 2 2; dur: 2000; loop: true"
          animation__fade="property: opacity; from: 0.8; to: 0; dur: 2000; loop: true">
        </a-ring>
      </a-entity>
    </a-entity>
  </a-scene>

  <script>
    const LOG = (s) => { document.getElementById('log').textContent = s; console.log(s); };
    const startBtn = document.getElementById('startBtn');
    const sceneEl = document.getElementById('arScene');

    // raw URL del archivo targets.mind (usa tu ruta raw)
    const rawUrl = "https://raw.githubusercontent.com/xTorres97/Camisasqr/master/targets.mind";

    async function setupMindARFromRaw() {
      try {
        LOG('Descargando targets.mind desde raw...');
        const resp = await fetch(rawUrl);
        if (!resp.ok) throw new Error('HTTP ' + resp.status + ' al descargar targets.mind');
        const arr = await resp.arrayBuffer();
        LOG('targets.mind descargado: ' + arr.byteLength + ' bytes — creando blob...');
        const blob = new Blob([arr], {type: 'application/octet-stream'});
        const blobUrl = URL.createObjectURL(blob);

        // Asignamos la URL blob como atributo a-scene para que MindAR la use
        LOG('Asignando blobUrl a atributo mindar-image (esto debe hacerse antes de cargar la librería MindAR)...');
        // nota: no usamos sceneEl.setAttribute('mindar-image', ...) todavía porque queremos construir la cadena completa
        sceneEl.setAttribute('mindar-image', 'imageTargetSrc: ' + blobUrl + '; autoStart: false;');

        // Ahora cargamos dinámicamente el script de MindAR (para que se inicialice con la carpeta ya configurada)
        LOG('Cargando script mindar-image-aframe.prod.js dinámicamente...');
        await new Promise((resolve, reject) => {
          const s = document.createElement('script');
          s.src = "https://cdn.jsdelivr.net/npm/mind-ar@1.1.4/dist/mindar-image-aframe.prod.js";
          s.onload = () => { LOG('Script MindAR cargado. Ya puede iniciar AR.'); resolve(); };
          s.onerror = (e) => { reject(new Error('No se pudo cargar la librería MindAR: ' + e)); };
          document.head.appendChild(s);
        });

        // Habilitar botón de inicio
        startBtn.style.display = 'inline-block';
        startBtn.disabled = false;
        LOG('Listo: pulsa "Activar AR" para iniciar la cámara.');

      } catch (e) {
        LOG('ERROR: ' + (e && e.message ? e.message : e));
        alert('Error cargando targets.mind: ' + (e && e.message ? e.message : e) + '. Revisa la consola.');
        console.error(e);
      }
    }

    // Arrancamos la preparación al cargar la página
    setupMindARFromRaw();

    startBtn.addEventListener('click', async () => {
      try {
        const mindarComp = sceneEl.components['mindar-image'];
        if (!mindarComp) {
          LOG('Componente mindar-image todavía no inicializado — espera 200ms e intenta de nuevo.');
          await new Promise(r => setTimeout(r, 200));
        }
        const mindar = sceneEl.components['mindar-image'];
        if (!mindar) throw new Error('mindar-image no está disponible aún. Recarga la página.');
        await mindar.start();
        startBtn.style.display = 'none';
        LOG('AR iniciado. Busca el marcador en la camiseta.');
      } catch (err) {
        LOG('Error al iniciar AR: ' + (err && err.message ? err.message : err));
        console.error(err);
        alert('Error al iniciar AR: ' + (err && err.message ? err.message : err));
      }
    });
  </script>
</body>
</html>